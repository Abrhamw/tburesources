{% extends 'base.html' %}

{% block title %}Tracking - {{ vehicle.plate_number }}{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Real-time Tracking: {{ vehicle.plate_number }}</h1>
        <a href="{{ url_for('index') }}" class="btn btn-secondary">
            <i class="fa-solid fa-arrow-left"></i> Back to Dashboard
        </a>
    </div>
    
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4><i class="fa-solid fa-map-location-dot"></i> Live GPS Tracking</h4>
                </div>
                <div class="card-body p-0" style="height: 600px;">
                    <div id="map" style="height: 100%; width: 100%;"></div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h4><i class="fa-solid fa-car"></i> Vehicle Information</h4>
                </div>
                <div class="card-body">
                    <p><strong>Plate Number:</strong> {{ vehicle.plate_number }}</p>
                    <p><strong>Type:</strong> {{ vehicle.vehicle_type }}</p>
                    <p><strong>Make/Model:</strong> {{ vehicle.make }} {{ vehicle.model }}</p>
                    <p><strong>Assigned For:</strong> {{ vehicle.assigned_for }}</p>
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h4><i class="fa-solid fa-user"></i> Driver Information</h4>
                </div>
                <div class="card-body">
                    <p><strong>Name:</strong> {{ assignment.driver.name }}</p>
                    <p><strong>ID:</strong> {{ assignment.driver.id_number }}</p>
                    <p><strong>Phone:</strong> {{ assignment.driver.phone }}</p>
                    <p><strong>Reporting To:</strong> {{ assignment.driver.reporting_to }}</p>
                </div>
            </div>
            
 <!-- In templates/tracking.html, update the tracking details panel -->
<div class="card">
    <div class="card-header bg-warning text-dark">
        <h4><i class="fa-solid fa-location-dot"></i> Live Tracking Details</h4>
    </div>
    <div class="card-body">
        <p><strong>Current Location:</strong> {{ assignment.work_place }}</p>
        <p><strong>GPS Coordinates:</strong> <span id="coordinates">{{ assignment.gps_position }}</span></p>
        <p><strong>Assignment Start:</strong> {{ assignment.start_date.strftime('%Y-%m-%d') }}</p>
        <p><strong>Geofence Violations:</strong> <span id="violations">{{ assignment.geofence_violations }}</span></p>
        
        <div id="position-info" class="mt-3 p-2 border rounded">
            <p class="text-center text-muted">Waiting for data...</p>
        </div>
        
        <div class="mt-3">
            <button id="refresh-btn" class="btn btn-primary w-100">
                <i class="fa-solid fa-rotate"></i> Refresh Now
            </button>
        </div>
    </div>
</div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Initialize the map
    const map = L.map('map').setView([{{ assignment.gps_position}}], 13);
    
    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    
    // Add vehicle marker with custom icon
    const vehicleIcon = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/2251/2251871.png',
        iconSize: [40, 40],
        iconAnchor: [20, 40],
        popupAnchor: [0, -40]
    });
    
    let marker = L.marker([{{ lat }}, {{ lng }}], {icon: vehicleIcon})
        .addTo(map)
        .bindPopup('<b>{{ vehicle.plate_number }}</b><br>{{ vehicle.vehicle_type }}');
    
    // Add geofence circle (example radius 5km)
    const geofence = L.circle([{{ lat }}, {{ lng }}], {
        color: 'red',
        fillColor: '#f03',
        fillOpacity: 0.1,
        radius: 5000
    }).addTo(map);
    
    // Refresh button functionality
    document.getElementById('refresh-btn').addEventListener('click', function() {
        // In a real app, this would fetch new data from the server
        // For demo, we'll just show a notification
        const notification = L.popup()
            .setLatLng([{{ lat }}, {{ lng }}])
            .setContent('Position refreshed at ' + new Date().toLocaleTimeString())
            .openOn(map);
            
        // Simulate slight position change for demo
        const latChange = (Math.random() - 0.5) * 0.01;
        const lngChange = (Math.random() - 0.5) * 0.01;
        
        const newLat = {{ lat }} + latChange;
        const newLng = {{ lng }} + lngChange;
        
        // Move marker to new position
        map.setView([newLat, newLng]);
        marker.setLatLng([newLat, newLng]);
        geofence.setLatLng([newLat, newLng]);
    });
    
    // Add real-time tracking simulation (for demo purposes)
    let simulationInterval;
    
    function startSimulation() {
        if (simulationInterval) clearInterval(simulationInterval);
        
        simulationInterval = setInterval(() => {
            const latChange = (Math.random() - 0.5) * 0.001;
            const lngChange = (Math.random() - 0.5) * 0.001;
            
            const newLat = marker.getLatLng().lat + latChange;
            const newLng = marker.getLatLng().lng + lngChange;
            
            marker.setLatLng([newLat, newLng]);
            map.panTo([newLat, newLng]);
            
            // Check geofence violation (if moved outside circle)
            const distance = map.distance(marker.getLatLng(), geofence.getLatLng());
            if (distance > 5000) {
                geofence.setStyle({color: 'red', fillColor: 'red'});
            } else {
                geofence.setStyle({color: 'green', fillColor: 'green'});
            }
        }, 3000);  // Update every 3 seconds
    }
    
    // Start simulation on page load
    startSimulation();
    
    // Stop simulation when leaving page
    window.addEventListener('beforeunload', function() {
        clearInterval(simulationInterval);
    });
</script>
{% endblock %}
